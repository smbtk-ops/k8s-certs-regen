# Ручная регенерация сертификатов Kubernetes

Это руководство описывает три метода ручной регенерации сертификатов в Kubernetes кластере без использования автоматических скриптов.

## Обзор методов

В этой директории представлены три подхода к ручной регенерации сертификатов:

1. **[OpenSSL](openssl.md)** - низкоуровневый контроль через стандартный OpenSSL
2. **[CFSSL](cfssl.md)** - специализированный инструмент CloudFlare для управления PKI
3. **[kubeadm](kubeadm.md)** - встроенный инструмент Kubernetes

## Сравнение методов

| Характеристика | OpenSSL | CFSSL | kubeadm |
|---|---|---|---|
| **Сложность** | Высокая | Средняя | Низкая |
| **Уровень контроля** | Максимальный | Высокий | Ограниченный |
| **Гибкость** | Полная | Высокая | Ограниченная |
| **Требует установки** | Нет (встроен) | Да | Да (обычно есть) |
| **Кривая обучения** | Крутая | Умеренная | Пологая |
| **Подходит для production** | Да | Да | Да |
| **Автоматизация** | Сложная | Простая | Ограниченная |
| **Поддержка SAN** | Полная | Полная | Частичная |
| **Кастомные параметры** | Все | Большинство | Базовые |
| **Multi-master** | Да | Да | Ограничена |
| **etcd сертификаты** | Полный контроль | Полный контроль | Частично |
| **Отдельные компоненты** | Да | Да | Ограничено |
| **Работа без kubeadm** | Да | Да | Нет |

## Преимущества и недостатки

### OpenSSL

**Преимущества:**
- Полный низкоуровневый контроль над всеми параметрами сертификатов
- Нет зависимостей - OpenSSL встроен в большинство систем
- Максимальная гибкость в создании сложных конфигураций
- Работает везде без установки дополнительных инструментов
- Можно создавать сертификаты с любыми нестандартными параметрами
- Отлично подходит для понимания PKI на глубоком уровне

**Недостатки:**
- Высокая сложность - легко допустить ошибку
- Много ручных шагов
- Сложный синтаксис конфигурационных файлов
- Требует глубокого понимания X.509 и PKI
- Трудно автоматизировать без написания скриптов
- Ручное управление всеми зависимостями между сертификатами

**Когда использовать:**
- Нужен полный контроль над параметрами сертификатов
- Специфичные требования к сертификатам
- Нет возможности установить дополнительные инструменты
- Обучение и понимание PKI
- Кастомные CA с нестандартными параметрами
- Кластеры установленные без kubeadm (например, Kubespray, Ansible, вручную)

### CFSSL

**Преимущества:**
- Специализирован для PKI и управления сертификатами
- Простые JSON конфигурационные файлы
- Встроенная поддержка профилей сертификатов
- Легко автоматизировать
- Мощный функционал для сложных PKI инфраструктур
- Валидация конфигурации
- Удобный API

**Недостатки:**
- Требует установки дополнительного инструмента
- Дополнительная зависимость
- Менее распространен чем OpenSSL
- Требует изучения CFSSL-специфичного синтаксиса

**Когда использовать:**
- Нужна автоматизация генерации сертификатов
- Сложная PKI с множеством сертификатов
- Требуется централизованное управление CA
- Планируется частая регенерация сертификатов
- Нужны профили для разных типов сертификатов
- Кластеры с нестандартными конфигурациями

### kubeadm

**Преимущества:**
- Простой и быстрый
- Встроен в Kubernetes
- Автоматически определяет многие параметры
- Минимум ручной работы
- Официально поддерживается Kubernetes
- Проверка совместимости с кластером

**Недостатки:**
- Ограниченная гибкость
- Не поддерживает все сценарии (например, сложные multi-master)
- Требует наличия kubeadm
- Ограниченная работа с etcd сертификатами
- Может не работать с кластерами установленными не через kubeadm
- Сложно кастомизировать SAN списки
- Не подходит для etcd в режиме systemd (Kubespray)

**Когда использовать:**
- Кластер был установлен через kubeadm
- Нужна быстрая регенерация стандартных сертификатов
- Простые конфигурации без кастомных требований
- Истек срок действия сертификатов, нужно быстро продлить
- Нет специфичных требований к SAN
- Single-master кластер или простой multi-master

## Рекомендации по выбору метода

### Сценарий 1: Полная миграция кластера

**Рекомендация:** OpenSSL или CFSSL

Полная миграция требует контроля над всеми параметрами, включая CA, SAN, etcd сертификаты. kubeadm не предоставляет достаточной гибкости.

### Сценарий 2: Истечение срока действия сертификатов

**Рекомендация:** kubeadm (если кластер установлен через kubeadm), иначе OpenSSL/CFSSL

Для быстрого продления сертификатов kubeadm наиболее прост. Если кластер установлен другим способом (Kubespray, Ansible) - используйте OpenSSL или CFSSL.

### Сценарий 3: Добавление новых SAN в API Server

**Рекомендация:** OpenSSL или CFSSL

Требуется точный контроль над SAN списками. kubeadm имеет ограничения в кастомизации SAN.

### Сценарий 4: Смена CA (например, компрометация)

**Рекомендация:** OpenSSL или CFSSL

Смена корневого CA - критическая операция требующая полного контроля. kubeadm не поддерживает смену CA.

### Сценарий 5: Восстановление после сбоя

**Рекомендация:** В зависимости от ситуации

- Если кластер установлен через kubeadm и сертификаты стандартные - kubeadm
- Если нужен точный контроль - OpenSSL
- Если есть готовые CFSSL конфиги - CFSSL

### Сценарий 6: Multi-master кластер с etcd systemd (Kubespray)

**Рекомендация:** OpenSSL или CFSSL

kubeadm не поддерживает etcd в режиме systemd. Требуется ручная генерация с hostname-specific сертификатами.

### Сценарий 7: Автоматизация регенерации

**Рекомендация:** CFSSL

CFSSL специально разработан для автоматизации. JSON конфиги легко генерируются и управляются программно.

### Сценарий 8: Обучение и понимание PKI

**Рекомендация:** OpenSSL

Ручная работа с OpenSSL дает глубокое понимание структуры сертификатов и PKI.

## Специфичные требования проекта k8s-certs-regen

Этот проект поддерживает следующие специфичные конфигурации, которые должны учитываться при ручной регенерации:

### USE_VIP (High Availability с VIP)

Если `USE_VIP="true"`:
- LB_VIP должен быть включен в SAN сертификата API Server
- Kubeconfig должен использовать VIP как server endpoint

Если `USE_VIP="false"`:
- Используется прямой IP первой master ноды
- Kubeconfig должен использовать MASTER_IP

### ETCD_TYPE (Тип развертывания etcd)

**systemd etcd (Kubespray):**
- Путь: `/etc/ssl/etcd/ssl/`
- Расширения: `.pem`
- Hostname-specific сертификаты: `node-master1.pem`, `member-master1.pem`, `admin-master1.pem`

**static-pod etcd (kubeadm):**
- Путь: `/etc/kubernetes/pki/etcd/`
- Расширения: `.crt`, `.key`
- Hostname-specific сертификаты: `node-master1.crt`, `member-master1.crt`, `admin-master1.crt`

### Multi-master особенности

- Каждая master нода должна иметь **уникальные** etcd сертификаты с hostname в имени
- etcd Server и Peer сертификаты должны включать **все** etcd ноды в SAN
- API Server сертификат должен быть **одинаковым** на всех master нодах
- etcd должен останавливаться **одновременно** на всех нодах перед заменой сертификатов

## Структура документации

Каждое руководство содержит:

1. **Введение** - когда использовать метод, требования
2. **Подготовка** - backup, проверка конфигурации, окружение
3. **Полная замена сертификатов** - пошаговая генерация всех сертификатов
4. **Модульное обновление** - обновление отдельных компонентов
5. **Применение на кластер** - копирование и активация сертификатов
6. **Проверка** - валидация результата
7. **Troubleshooting** - типичные проблемы и решения
8. **Откат** - процедура возврата к старым сертификатам

## Важные предупреждения

**Перед началом работы:**

1. **ОБЯЗАТЕЛЬНО создайте backup** всех существующих сертификатов
2. **Планируйте maintenance window** - кластер будет недоступен 5-10 минут
3. **Протестируйте в staging окружении** если возможно
4. **Проверьте конфигурацию** - USE_VIP, ETCD_TYPE, API_SERVER_SANS
5. **Подготовьте план отката** на случай проблем

**Критические моменты:**

- Multi-master кластер требует **одновременной** замены etcd сертификатов на всех нодах
- Неправильный SAN в API Server сертификате приведет к недоступности кластера
- etcd сертификаты должны быть **hostname-specific** для каждой ноды
- После замены CA необходимо обновить **все** kubeconfig файлы

## Ссылки на детальные инструкции

- **[OpenSSL - полное руководство](openssl.md)**
- **[CFSSL - полное руководство](cfssl.md)**
- **[kubeadm - полное руководство](kubeadm.md)**

## Автоматизация

Если вам не нужна ручная регенерация, используйте автоматизированные скрипты проекта:

```bash
# Полная автоматическая регенерация всех сертификатов
./scripts/regenerate-all.sh

# Применение на кластер с минимальным downtime
./scripts/apply-all-at-once.sh
```

Автоматические скрипты учитывают все особенности:
- USE_VIP и автоматическое добавление VIP в SAN
- ETCD_TYPE с авто-определением типа развертывания
- Hostname-specific сертификаты для etcd
- Одновременная остановка/запуск etcd на всех нодах
- Автоматический backup на каждой ноде
- Rollback при ошибках

Детали в основном [README.md](../../README.md).
